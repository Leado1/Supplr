// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String       @id @default(cuid())
  clerkId        String       @unique
  email          String       @unique
  firstName      String?
  lastName       String?
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // New fields for team management
  role           OrganizationRole @default(OWNER)
  status         UserStatus       @default(ACTIVE)
  invitedBy      String?          // Who invited this user
  joinedAt       DateTime         @default(now())
  lastActiveAt   DateTime?

  // Relations for invitations
  sentInvitations UserInvitation[] @relation("SentInvitations")

  // Multi-location support
  userLocations  UserLocation[]   // Locations this user has access to

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@map("users")
}

model Organization {
  id           String        @id @default(cuid())
  name         String
  type         String        @default("clinic") // clinic, medspa, etc.
  users        User[]
  categories   Category[]
  items        Item[]
  settings     Settings?
  subscription Subscription?
  invitations  UserInvitation[] // Team invitations
  locations    Location[]    // Multi-location support for Enterprise
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@map("organizations")
}

model Location {
  id             String       @id @default(cuid())
  name           String       // "Main Clinic", "Downtown Branch", etc.
  address        String?      // Physical address
  phone          String?      // Location-specific phone
  email          String?      // Location-specific email
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Location-specific settings
  timezone       String       @default("UTC")
  currency       String       @default("USD")
  isActive       Boolean      @default(true)

  // Relations
  items          Item[]       // Items specific to this location
  categories     Category[]   // Categories specific to this location
  userLocations  UserLocation[] // Users assigned to this location

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([organizationId, name]) // Unique location names within organization
  @@map("locations")
}

model UserLocation {
  id         String   @id @default(cuid())
  userId     String
  locationId String
  role       LocationRole @default(MEMBER) // Location-specific role
  isDefault  Boolean  @default(false) // Default location for this user

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([userId, locationId]) // User can only be assigned once per location
  @@map("user_locations")
}

model UserInvitation {
  id             String   @id @default(cuid())
  email          String
  organizationId String
  role           OrganizationRole @default(MEMBER)
  invitedBy      String
  token          String   @unique
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  inviter        User         @relation("SentInvitations", fields: [invitedBy], references: [id])

  @@unique([email, organizationId])
  @@map("user_invitations")
}

model Settings {
  id                    String       @id @default(cuid())
  organizationId        String       @unique
  organization          Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  expirationWarningDays Int          @default(30)
  lowStockThreshold     Int          @default(5)
  currency              String       @default("USD")
  timezone              String       @default("UTC")
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt

  @@map("settings")
}

model Category {
  id             String       @id @default(cuid())
  name           String
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Multi-location support - nullable for backward compatibility
  locationId     String?
  location       Location?    @relation(fields: [locationId], references: [id], onDelete: Cascade)

  items          Item[]
  createdAt      DateTime     @default(now())

  @@unique([organizationId, name]) // Unique category names per organization (legacy)
  @@index([organizationId, locationId]) // Index for location-based queries
  @@map("categories")
}

model Item {
  id               String       @id @default(cuid())
  name             String
  sku              String?
  categoryId       String
  category         Category     @relation(fields: [categoryId], references: [id])
  quantity         Int
  unitCost         Decimal
  expirationDate   DateTime
  reorderThreshold Int
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Multi-location support - nullable for backward compatibility
  locationId       String?
  location         Location?    @relation(fields: [locationId], references: [id], onDelete: Cascade)

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  @@map("items")
}

model Subscription {
  id                 String       @id @default(cuid())
  organizationId     String       @unique
  organization       Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Stripe fields
  stripeCustomerId       String?  @unique
  stripeSubscriptionId   String?  @unique
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?

  // Subscription details
  plan               String       @default("trial") // trial, starter, professional, enterprise
  status             String       @default("trialing") // trialing, active, canceled, incomplete, past_due
  itemLimit          Int          @default(5) // Number of items allowed
  isActive           Boolean      @default(true)

  // Feature flags for plan-based restrictions
  advancedAnalytics  Boolean      @default(false) // Professional+
  customCategories   Boolean      @default(false) // Professional+
  apiAccess          Boolean      @default(false) // Enterprise only
  multiLocation      Boolean      @default(false) // Enterprise only
  customReports      Boolean      @default(false) // Enterprise only
  trialEndsAt        DateTime?
  canceledAt         DateTime?

  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  @@map("subscriptions")
}

enum OrganizationRole {
  OWNER          // Practice owner - full access + billing
  ADMIN          // Office manager - user management + inventory
  MANAGER        // Lead medical staff - inventory management
  MEMBER         // Staff - view + basic updates
}

enum UserStatus {
  ACTIVE         // Active team member
  PENDING        // Invitation sent but not accepted
  SUSPENDED      // Temporarily disabled
}

enum LocationRole {
  MANAGER        // Can manage inventory at this location
  MEMBER         // Can view and update inventory at this location
  VIEWER         // Can only view inventory at this location
}