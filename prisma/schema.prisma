// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id             String       @id @default(cuid())
  clerkId        String       @unique
  email          String       @unique
  firstName      String?
  lastName       String?
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // New fields for team management
  role           OrganizationRole @default(OWNER)
  status         UserStatus       @default(ACTIVE)
  invitedBy      String?          // Who invited this user
  joinedAt       DateTime         @default(now())
  lastActiveAt   DateTime?

  // Relations for invitations
  sentInvitations UserInvitation[] @relation("SentInvitations")

  // Multi-location support
  userLocations  UserLocation[]   // Locations this user has access to

  // Supplier tracking
  supplierInteractions SupplierInteraction[] // User's supplier interactions

  // Purchasing
  createdPurchaseOrders  PurchaseOrder[] @relation("PurchaseOrderCreatedBy")
  approvedPurchaseOrders PurchaseOrder[] @relation("PurchaseOrderApprovedBy")

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@map("users")
}

model Organization {
  id           String        @id @default(cuid())
  name         String
  type         String        @default("clinic") // clinic, medspa, etc.
  users        User[]
  categories   Category[]
  items        Item[]
  settings     Settings?
  subscription Subscription?
  invitations  UserInvitation[] // Team invitations
  locations    Location[]    // Multi-location support for Enterprise

  // AI Relations
  aiPredictions     AIPrediction[]    // AI predictions for this organization
  inventoryChanges  InventoryChange[] // Historical changes for AI learning
  aiFeatureUsage    AIFeatureUsage[]  // AI feature usage tracking

  // Supplier Relations
  supplierPreferences SupplierPreference[] // Preferred suppliers and contract terms
  supplierInteractions SupplierInteraction[] // Tracking of supplier clicks and orders
  purchaseOrders      PurchaseOrder[] // Draft and submitted purchase orders

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@map("organizations")
}

model Location {
  id             String       @id @default(cuid())
  name           String       // "Main Clinic", "Downtown Branch", etc.
  address        String?      // Physical address
  phone          String?      // Location-specific phone
  email          String?      // Location-specific email
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Location-specific settings
  timezone       String       @default("UTC")
  currency       String       @default("USD")
  isActive       Boolean      @default(true)

  // Relations
  items          Item[]       // Items specific to this location
  categories     Category[]   // Categories specific to this location
  userLocations  UserLocation[] // Users assigned to this location
  purchaseOrders PurchaseOrder[] // Purchase orders for this location

  // AI Relations
  inventoryChanges InventoryChange[] // Historical changes at this location

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([organizationId, name]) // Unique location names within organization
  @@map("locations")
}

model UserLocation {
  id         String   @id @default(cuid())
  userId     String
  locationId String
  role       LocationRole @default(MEMBER) // Location-specific role
  isDefault  Boolean  @default(false) // Default location for this user

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([userId, locationId]) // User can only be assigned once per location
  @@map("user_locations")
}

model UserInvitation {
  id             String   @id @default(cuid())
  email          String
  organizationId String
  role           OrganizationRole @default(MEMBER)
  invitedBy      String
  token          String   @unique
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  inviter        User         @relation("SentInvitations", fields: [invitedBy], references: [id])

  @@unique([email, organizationId])
  @@map("user_invitations")
}

model Settings {
  id                    String       @id @default(cuid())
  organizationId        String       @unique
  organization          Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  expirationWarningDays Int          @default(30)
  lowStockThreshold     Int          @default(5)
  currency              String       @default("USD")
  timezone              String       @default("UTC")
  aiAutoDraftEnabled    Boolean      @default(false)
  aiRequireApproval     Boolean      @default(false)
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt

  @@map("settings")
}

model Category {
  id             String       @id @default(cuid())
  name           String
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Multi-location support - nullable for backward compatibility
  locationId     String?
  location       Location?    @relation(fields: [locationId], references: [id], onDelete: Cascade)

  items          Item[]
  createdAt      DateTime     @default(now())

  @@unique([organizationId, name]) // Unique category names per organization (legacy)
  @@index([organizationId, locationId]) // Index for location-based queries
  @@map("categories")
}

model Item {
  id               String       @id @default(cuid())
  name             String
  sku              String?
  categoryId       String
  category         Category     @relation(fields: [categoryId], references: [id])
  quantity         Int
  unitCost         Decimal
  expirationDate   DateTime
  reorderThreshold Int
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Multi-location support - nullable for backward compatibility
  locationId       String?
  location         Location?    @relation(fields: [locationId], references: [id], onDelete: Cascade)

  // AI Relations
  aiPredictions    AIPrediction[]    // AI predictions for this item
  inventoryChanges InventoryChange[] // Historical changes for this item

  // Supplier Relations
  supplierInteractions SupplierInteraction[] // Supplier interactions for this item
  purchaseOrderItems   PurchaseOrderItem[] // Purchase order lines

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  @@map("items")
}

model Subscription {
  id                 String       @id @default(cuid())
  organizationId     String       @unique
  organization       Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Polar.sh fields
  polarCustomerId        String?  @unique
  polarSubscriptionId    String?  @unique
  polarProductId         String?  // Maps to your Polar product IDs
  polarCurrentPeriodEnd  DateTime?

  // Legacy Stripe fields (keep for migration)
  stripeCustomerId       String?  @unique
  stripeSubscriptionId   String?  @unique
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?

  // Subscription details
  plan               String       @default("trial") // trial, starter, professional, enterprise
  status             String       @default("trialing") // trialing, active, canceled, incomplete, past_due
  itemLimit          Int          @default(5) // Number of items allowed
  isActive           Boolean      @default(true)

  // Feature flags for plan-based restrictions
  advancedAnalytics  Boolean      @default(false) // Professional+
  customCategories   Boolean      @default(false) // Professional+
  apiAccess          Boolean      @default(false) // Enterprise only
  multiLocation      Boolean      @default(false) // Enterprise only
  customReports      Boolean      @default(false) // Enterprise only
  trialEndsAt        DateTime?
  canceledAt         DateTime?

  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  @@map("subscriptions")
}

enum OrganizationRole {
  OWNER          // Practice owner - full access + billing
  ADMIN          // Office manager - user management + inventory
  MANAGER        // Lead medical staff - inventory management
  MEMBER         // Staff - view + basic updates
}

enum UserStatus {
  ACTIVE         // Active team member
  PENDING        // Invitation sent but not accepted
  SUSPENDED      // Temporarily disabled
}

enum LocationRole {
  MANAGER        // Can manage inventory at this location
  MEMBER         // Can view and update inventory at this location
  VIEWER         // Can only view inventory at this location
}

enum PurchaseOrderStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  ORDERED
  CANCELLED
}

// AI Prediction Models
model AIPrediction {
  id                String       @id @default(cuid())
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  itemId            String?
  item              Item?        @relation(fields: [itemId], references: [id], onDelete: Cascade)

  predictionType    String       // 'reorder', 'waste_risk', 'threshold_optimization', 'demand_forecast'
  predictionValue   Json         // Flexible JSON for different prediction types
  confidenceScore   Decimal      @db.Decimal(3,2) // 0.00 to 1.00

  // Metadata
  modelVersion      String       @default("1.0")
  expiresAt         DateTime?    // Cache expiration
  actioned          Boolean      @default(false) // User acted on this prediction
  feedbackScore     Int?         // User feedback: -1 (bad), 0 (neutral), 1 (good)

  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@index([organizationId, predictionType])
  @@index([organizationId, itemId])
  @@index([expiresAt])
  @@map("ai_predictions")
}

// Historical Inventory Change Tracking for AI Learning
model InventoryChange {
  id               String       @id @default(cuid())
  itemId           String
  item             Item         @relation(fields: [itemId], references: [id], onDelete: Cascade)
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  quantityBefore   Int
  quantityAfter    Int
  changeType       String       // 'usage', 'restock', 'waste', 'transfer', 'adjustment', 'audit'
  changeReason     String?      // Optional context for the change

  // Metadata
  changedBy        String?      // User ID who made the change
  locationId       String?      // Which location this change occurred at
  location         Location?    @relation(fields: [locationId], references: [id], onDelete: SetNull)

  createdAt        DateTime     @default(now())

  @@index([organizationId, itemId])
  @@index([organizationId, changeType])
  @@index([itemId, createdAt])
  @@map("inventory_changes")
}

// AI Feature Usage Tracking
model AIFeatureUsage {
  id               String       @id @default(cuid())
  organizationId   String
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  featureType      String       // 'reorder_prediction', 'waste_prevention', 'threshold_optimization'
  usageCount       Int          @default(0)
  monthYear        String       // Format: "2025-01" for quota tracking

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  @@unique([organizationId, featureType, monthYear])
  @@index([organizationId, monthYear])
  @@map("ai_feature_usage")
}

// Supplier Integration Models
model SupplierPreference {
  id                String       @id @default(cuid())
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  supplierId        String       // External supplier ID (mckesson, cardinal, etc.)
  supplierName      String
  preferenceLevel   String       @default("neutral") // 'preferred', 'neutral', 'excluded'
  contractTerms     Json?        // Pricing agreements, delivery terms, etc.
  accountNumber     String?      // Organization's account number with supplier

  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@unique([organizationId, supplierId])
  @@index([organizationId])
  @@map("supplier_preferences")
}

model SupplierInteraction {
  id                String       @id @default(cuid())
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  userId            String?
  user              User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  itemId            String?
  item              Item?        @relation(fields: [itemId], references: [id], onDelete: SetNull)

  supplierId        String       // External supplier ID
  supplierName      String
  actionType        String       // 'clicked_link', 'placed_order', 'saved_for_later', 'dismissed'
  estimatedValue    Decimal?     @db.Decimal(10,2)
  actualOrderValue  Decimal?     @db.Decimal(10,2) // If order was actually placed
  orderReference    String?      // External order ID if available

  metadata          Json?        // Additional tracking data

  createdAt         DateTime     @default(now())

  @@index([organizationId, createdAt])
  @@index([supplierId, actionType])
  @@map("supplier_interactions")
}

model PurchaseOrder {
  id                 String              @id @default(cuid())
  organizationId     String
  organization       Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  locationId         String?
  location           Location?           @relation(fields: [locationId], references: [id], onDelete: SetNull)

  createdBy          String?
  createdByUser      User?               @relation("PurchaseOrderCreatedBy", fields: [createdBy], references: [id], onDelete: SetNull)

  approvedBy         String?
  approvedByUser     User?               @relation("PurchaseOrderApprovedBy", fields: [approvedBy], references: [id], onDelete: SetNull)

  status             PurchaseOrderStatus @default(DRAFT)
  source             String?
  totalEstimatedCost Decimal?            @db.Decimal(12,2)
  notes              String?

  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  items              PurchaseOrderItem[]

  @@index([organizationId, status])
  @@index([locationId])
  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id              String        @id @default(cuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  itemId          String
  item            Item          @relation(fields: [itemId], references: [id], onDelete: Cascade)

  quantity        Int
  unitCost        Decimal       @db.Decimal(10,2)
  estimatedCost   Decimal       @db.Decimal(12,2)
  supplierId      String?
  supplierName    String?
  orderingUrl     String?
  aiPredictionId  String?

  createdAt       DateTime      @default(now())

  @@index([itemId])
  @@index([purchaseOrderId])
  @@map("purchase_order_items")
}
